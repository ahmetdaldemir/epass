{
    "sourceFile": "src/views/CheckoutView.vue",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1755552618152,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1755679282816,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -156,9 +156,9 @@\n   </div>\r\n </template>\r\n \r\n <script setup>\r\n-import { ref, onMounted, watch, computed } from 'vue'\r\n+import { ref, onMounted, onUnmounted, watch, computed } from 'vue'\r\n import { useRouter } from 'vue-router'\r\n import { useSelectedTourStore } from '../stores/selectedTour'\r\n let stripe, elements, card\r\n import { loadStripe } from '@stripe/stripe-js';\r\n@@ -248,8 +248,11 @@\n const currentCurrency = ref(localStorage.getItem('selectedCurrency') || 'EUR')\r\n const currencyId = computed(() => getCurrencyId(currentCurrency.value))\r\n const languageId = computed(() => getLanguageId(localStorage.getItem('selectedLanguage') || 'en'))\r\n \r\n+// Observer için ref\r\n+const accessibilityObserver = ref(null)\r\n+\r\n onMounted(() => {\r\n   watch(currentStep, (step) => {\r\n     if (step === 2) {\r\n       setTimeout(() => {\r\n@@ -263,10 +266,41 @@\n         }\r\n       }, 0)\r\n     }\r\n   }, { immediate: true })\r\n+  \r\n+  // Global erişilebilirlik düzeltmesi\r\n+  accessibilityObserver.value = new MutationObserver((mutations) => {\r\n+    mutations.forEach((mutation) => {\r\n+      mutation.addedNodes.forEach((node) => {\r\n+        if (node.nodeType === Node.ELEMENT_NODE) {\r\n+          // Stripe'ın oluşturduğu gizli input elementlerini bul ve düzelt\r\n+          const hiddenInputs = node.querySelectorAll ? node.querySelectorAll('input[aria-hidden=\"true\"]') : []\r\n+          hiddenInputs.forEach((input) => {\r\n+            // Bu elementlerin focus almasını engelle\r\n+            input.setAttribute('tabindex', '-1')\r\n+            input.setAttribute('aria-hidden', 'true')\r\n+            input.style.pointerEvents = 'none'\r\n+          })\r\n+        }\r\n+      })\r\n+    })\r\n+  })\r\n+  \r\n+  accessibilityObserver.value.observe(document.body, {\r\n+    childList: true,\r\n+    subtree: true\r\n+  })\r\n })\r\n \r\n+onUnmounted(() => {\r\n+  // Component unmount olduğunda observer'ı temizle\r\n+  if (accessibilityObserver.value) {\r\n+    accessibilityObserver.value.disconnect()\r\n+    accessibilityObserver.value = null\r\n+  }\r\n+})\r\n+\r\n function setupStripe() {\r\n   if (card) return\r\n   // Stripe public key - production'da gerçek key kullanılacak\r\n   stripe = window.Stripe('pk_test_51RmaYhQQzUg4uq68XfoINf2CrffnJsjaJ1OHLwLtNLHHKcJ2uPlQABvQi5gFefQ5CnyJtbBbLOK7yioo2pPhkzfS00bUBXgBV7') // TODO: Replace with your real public key\r\n@@ -283,9 +317,40 @@\n       invalid: {\r\n         color: '#9e2146',\r\n       },\r\n     },\r\n+    // Erişilebilirlik için ek konfigürasyonlar\r\n+    hidePostalCode: false,\r\n+    iconStyle: 'solid',\r\n+    // Focus yönetimi için\r\n+    classes: {\r\n+      focus: 'focused',\r\n+      invalid: 'invalid',\r\n+    }\r\n   })\r\n+  \r\n+  // Card element'ini mount etmeden önce container'ı hazırla\r\n+  const cardElement = document.getElementById('card-element')\r\n+  if (cardElement) {\r\n+    // Container'a erişilebilirlik özellikleri ekle\r\n+    cardElement.setAttribute('role', 'group')\r\n+    cardElement.setAttribute('aria-label', 'Credit card information')\r\n+    \r\n+    // Stripe'ın oluşturduğu gizli elementlerin focus almasını engelle\r\n+    cardElement.addEventListener('focusin', (e) => {\r\n+      const target = e.target\r\n+      if (target.classList.contains('__PrivateStripeElement-input') && target.getAttribute('aria-hidden') === 'true') {\r\n+        // Gizli element focus aldıysa, ana card element'ine focus'u geri ver\r\n+        setTimeout(() => {\r\n+          const visibleInputs = cardElement.querySelectorAll('input:not([aria-hidden=\"true\"])')\r\n+          if (visibleInputs.length > 0) {\r\n+            visibleInputs[0].focus()\r\n+          }\r\n+        }, 0)\r\n+      }\r\n+    })\r\n+  }\r\n+  \r\n   card.mount('#card-element')\r\n }\r\n \r\n function getLocation() {\r\n@@ -573,9 +638,29 @@\n   border-radius: 10px;\r\n   border: 2px solid #e0e6ed;\r\n   background: #f7fafd;\r\n   margin-top: 4px;\r\n+  /* Erişilebilirlik için ek stiller */\r\n+  position: relative;\r\n+  overflow: hidden;\r\n }\r\n+\r\n+/* Stripe'ın gizli elementlerini tamamen gizle */\r\n+.stripe-card-element input[aria-hidden=\"true\"] {\r\n+  position: absolute !important;\r\n+  left: -9999px !important;\r\n+  width: 1px !important;\r\n+  height: 1px !important;\r\n+  opacity: 0 !important;\r\n+  pointer-events: none !important;\r\n+  z-index: -1 !important;\r\n+}\r\n+\r\n+/* Focus durumunda görsel geri bildirim */\r\n+.stripe-card-element.focused {\r\n+  border-color: #0070eb;\r\n+  box-shadow: 0 0 0 3px rgba(0, 112, 235, 0.1);\r\n+}\r\n .form-note {\r\n   font-size: 0.97rem;\r\n   color: #888;\r\n   margin-bottom: 8px;\r\n"
                },
                {
                    "date": 1755679471485,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -156,9 +156,9 @@\n   </div>\r\n </template>\r\n \r\n <script setup>\r\n-import { ref, onMounted, onUnmounted, watch, computed } from 'vue'\r\n+import { ref, onMounted, watch, computed } from 'vue'\r\n import { useRouter } from 'vue-router'\r\n import { useSelectedTourStore } from '../stores/selectedTour'\r\n let stripe, elements, card\r\n import { loadStripe } from '@stripe/stripe-js';\r\n@@ -248,11 +248,8 @@\n const currentCurrency = ref(localStorage.getItem('selectedCurrency') || 'EUR')\r\n const currencyId = computed(() => getCurrencyId(currentCurrency.value))\r\n const languageId = computed(() => getLanguageId(localStorage.getItem('selectedLanguage') || 'en'))\r\n \r\n-// Observer için ref\r\n-const accessibilityObserver = ref(null)\r\n-\r\n onMounted(() => {\r\n   watch(currentStep, (step) => {\r\n     if (step === 2) {\r\n       setTimeout(() => {\r\n@@ -266,41 +263,10 @@\n         }\r\n       }, 0)\r\n     }\r\n   }, { immediate: true })\r\n-  \r\n-  // Global erişilebilirlik düzeltmesi\r\n-  accessibilityObserver.value = new MutationObserver((mutations) => {\r\n-    mutations.forEach((mutation) => {\r\n-      mutation.addedNodes.forEach((node) => {\r\n-        if (node.nodeType === Node.ELEMENT_NODE) {\r\n-          // Stripe'ın oluşturduğu gizli input elementlerini bul ve düzelt\r\n-          const hiddenInputs = node.querySelectorAll ? node.querySelectorAll('input[aria-hidden=\"true\"]') : []\r\n-          hiddenInputs.forEach((input) => {\r\n-            // Bu elementlerin focus almasını engelle\r\n-            input.setAttribute('tabindex', '-1')\r\n-            input.setAttribute('aria-hidden', 'true')\r\n-            input.style.pointerEvents = 'none'\r\n-          })\r\n-        }\r\n-      })\r\n-    })\r\n-  })\r\n-  \r\n-  accessibilityObserver.value.observe(document.body, {\r\n-    childList: true,\r\n-    subtree: true\r\n-  })\r\n })\r\n \r\n-onUnmounted(() => {\r\n-  // Component unmount olduğunda observer'ı temizle\r\n-  if (accessibilityObserver.value) {\r\n-    accessibilityObserver.value.disconnect()\r\n-    accessibilityObserver.value = null\r\n-  }\r\n-})\r\n-\r\n function setupStripe() {\r\n   if (card) return\r\n   // Stripe public key - production'da gerçek key kullanılacak\r\n   stripe = window.Stripe('pk_test_51RmaYhQQzUg4uq68XfoINf2CrffnJsjaJ1OHLwLtNLHHKcJ2uPlQABvQi5gFefQ5CnyJtbBbLOK7yioo2pPhkzfS00bUBXgBV7') // TODO: Replace with your real public key\r\n@@ -317,40 +283,9 @@\n       invalid: {\r\n         color: '#9e2146',\r\n       },\r\n     },\r\n-    // Erişilebilirlik için ek konfigürasyonlar\r\n-    hidePostalCode: false,\r\n-    iconStyle: 'solid',\r\n-    // Focus yönetimi için\r\n-    classes: {\r\n-      focus: 'focused',\r\n-      invalid: 'invalid',\r\n-    }\r\n   })\r\n-  \r\n-  // Card element'ini mount etmeden önce container'ı hazırla\r\n-  const cardElement = document.getElementById('card-element')\r\n-  if (cardElement) {\r\n-    // Container'a erişilebilirlik özellikleri ekle\r\n-    cardElement.setAttribute('role', 'group')\r\n-    cardElement.setAttribute('aria-label', 'Credit card information')\r\n-    \r\n-    // Stripe'ın oluşturduğu gizli elementlerin focus almasını engelle\r\n-    cardElement.addEventListener('focusin', (e) => {\r\n-      const target = e.target\r\n-      if (target.classList.contains('__PrivateStripeElement-input') && target.getAttribute('aria-hidden') === 'true') {\r\n-        // Gizli element focus aldıysa, ana card element'ine focus'u geri ver\r\n-        setTimeout(() => {\r\n-          const visibleInputs = cardElement.querySelectorAll('input:not([aria-hidden=\"true\"])')\r\n-          if (visibleInputs.length > 0) {\r\n-            visibleInputs[0].focus()\r\n-          }\r\n-        }, 0)\r\n-      }\r\n-    })\r\n-  }\r\n-  \r\n   card.mount('#card-element')\r\n }\r\n \r\n function getLocation() {\r\n@@ -638,29 +573,9 @@\n   border-radius: 10px;\r\n   border: 2px solid #e0e6ed;\r\n   background: #f7fafd;\r\n   margin-top: 4px;\r\n-  /* Erişilebilirlik için ek stiller */\r\n-  position: relative;\r\n-  overflow: hidden;\r\n }\r\n-\r\n-/* Stripe'ın gizli elementlerini tamamen gizle */\r\n-.stripe-card-element input[aria-hidden=\"true\"] {\r\n-  position: absolute !important;\r\n-  left: -9999px !important;\r\n-  width: 1px !important;\r\n-  height: 1px !important;\r\n-  opacity: 0 !important;\r\n-  pointer-events: none !important;\r\n-  z-index: -1 !important;\r\n-}\r\n-\r\n-/* Focus durumunda görsel geri bildirim */\r\n-.stripe-card-element.focused {\r\n-  border-color: #0070eb;\r\n-  box-shadow: 0 0 0 3px rgba(0, 112, 235, 0.1);\r\n-}\r\n .form-note {\r\n   font-size: 0.97rem;\r\n   color: #888;\r\n   margin-bottom: 8px;\r\n"
                },
                {
                    "date": 1755718424379,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -513,8 +513,9 @@\n   justify-content: center;\r\n   background: #f6f8fa;\r\n   padding: 48px 0;\r\n   min-height: 100vh;\r\n+  padding-top: 120px;\r\n }\r\n .checkout-left, .checkout-right {\r\n   flex: 1 1 0;\r\n   min-width: 340px;\r\n"
                },
                {
                    "date": 1755719730823,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -513,9 +513,9 @@\n   justify-content: center;\r\n   background: #f6f8fa;\r\n   padding: 48px 0;\r\n   min-height: 100vh;\r\n-  padding-top: 120px;\r\n+  margin-top: 120px;\r\n }\r\n .checkout-left, .checkout-right {\r\n   flex: 1 1 0;\r\n   min-width: 340px;\r\n"
                },
                {
                    "date": 1756128829032,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -513,9 +513,8 @@\n   justify-content: center;\r\n   background: #f6f8fa;\r\n   padding: 48px 0;\r\n   min-height: 100vh;\r\n-  margin-top: 120px;\r\n }\r\n .checkout-left, .checkout-right {\r\n   flex: 1 1 0;\r\n   min-width: 340px;\r\n"
                }
            ],
            "date": 1755552618152,
            "name": "Commit-0",
            "content": "<template>\r\n  <div class=\"checkout-main-layout\">\r\n    <!-- SOL: Kişisel Bilgiler ve Ödeme Formu (Stepper) -->\r\n    <div class=\"checkout-left\">\r\n      <h2>Enter your personal details</h2>\r\n      <div class=\"secure-checkout\">\r\n        <i class=\"fas fa-lock\"></i> Checkout is fast and secure\r\n      </div>\r\n      <form @submit.prevent=\"handleStep\" class=\"checkout-form\">\r\n        <template v-if=\"currentStep === 1\">\r\n          <div class=\"form-group\">\r\n            <label>Full name <span class=\"required\">*</span></label>\r\n            <input v-model=\"name\" type=\"text\" required placeholder=\"Full Name\" />\r\n          </div>\r\n          <div class=\"form-group\">\r\n            <label>Email <span class=\"required\">*</span></label>\r\n            <input v-model=\"email\" type=\"email\" required placeholder=\"you@email.com\" />\r\n          </div>\r\n          <div class=\"form-group\">\r\n            <label>Country <span class=\"required\">*</span></label>\r\n            <select v-model=\"country\" class=\"country-select-fullwidth\">\r\n              <option v-for=\"c in countries\" :key=\"c.iso\" :value=\"c.name\">\r\n                {{ c.name }}\r\n              </option>\r\n            </select>\r\n          </div>\r\n          <div class=\"form-group phone-row\">\r\n            <label>Mobile phone number <span class=\"required\">*</span></label>\r\n            <div class=\"phone-input-group\">\r\n              <div class=\"country-code-display\">\r\n                <img :src=\"`https://flagsapi.com/${selectedCountry.iso}/flat/24.png`\" :alt=\"selectedCountry.name\" class=\"flag-option\" />\r\n                <span>{{ selectedCountry.code }}</span>\r\n              </div>\r\n              <input\r\n                v-model=\"phone\"\r\n                type=\"tel\"\r\n                required\r\n                class=\"phone-input\"\r\n                :placeholder=\"selectedCountry.iso === 'TR' ? '5xx xxx xx xx' : selectedCountry.iso === 'US' ? 'xxx xxx xxxx' : selectedCountry.iso === 'DE' ? '1xx xxxxxxx' : 'xx xx xx xx'\"\r\n              />\r\n            </div>\r\n          </div>\r\n          <div class=\"form-group\">\r\n            <label>Hotel Address <span class=\"required\">*</span></label>\r\n            <input v-model=\"hotelAddress\" type=\"text\" required placeholder=\"Enter your hotel address\" />\r\n          </div>\r\n          <div class=\"form-group\">\r\n            <label>Your Location (optional)</label>\r\n            <div style=\"display: flex; gap: 8px;\">\r\n              <input\r\n                v-model=\"userLocation\"\r\n                type=\"text\"\r\n                placeholder=\"Click the button to add your current location\"\r\n                readonly\r\n                class=\"input\"\r\n                style=\"flex: 1;\"\r\n              />\r\n              <button type=\"button\" @click=\"getLocation\" class=\"location-btn\" title=\"Use my location\">📍</button>\r\n            </div>\r\n            <div v-if=\"userLocation\">\r\n              <a\r\n                :href=\"getGoogleMapsLink(userLocation)\"\r\n                target=\"_blank\"\r\n                rel=\"noopener\"\r\n                style=\"color: #0070eb; text-decoration: underline; cursor: pointer; font-size:0.97em;\"\r\n              >\r\n                View on Google Maps\r\n              </a>\r\n            </div>\r\n          </div>\r\n          <div class=\"form-note\">We’ll only contact you with essential updates or changes to your booking</div>\r\n          <button class=\"pay-btn\" type=\"submit\">Go to payment</button>\r\n        </template>\r\n        <template v-else>\r\n          <div class=\"form-group\">\r\n            <label>Name on Card <span class=\"required\">*</span></label>\r\n            <input v-model=\"cardName\" type=\"text\" required placeholder=\"Name on Card\" />\r\n          </div>\r\n          <div class=\"form-group\">\r\n            <label>Card Details</label>\r\n            <div id=\"card-element\" class=\"stripe-card-element\"></div>\r\n          </div>\r\n          <button class=\"pay-btn\" :disabled=\"loading\" type=\"submit\">\r\n            <span v-if=\"loading\">Processing...</span>\r\n            <span v-else>Pay Now</span>\r\n          </button>\r\n          <div v-if=\"success\" class=\"success-message\">\r\n            <i class=\"fas fa-check-circle\"></i> \r\n            <div>\r\n              <strong>Payment Successful!</strong>\r\n              <p>Your booking has been confirmed. You will receive a confirmation email shortly.</p>\r\n            </div>\r\n          </div>\r\n          <div v-if=\"errorMsg\" class=\"error-message\">\r\n            <i class=\"fas fa-exclamation-circle\"></i> {{ errorMsg }}\r\n          </div>\r\n        </template>\r\n      </form>\r\n    </div>\r\n    <!-- SAĞ: Order Summary -->\r\n    <div class=\"checkout-right\">\r\n      <div class=\"order-summary-panel\" v-if=\"selectedTourStore.tour || selectedTourStore.pass\">\r\n        <div class=\"order-summary-title\">Order summary</div>\r\n        \r\n        <!-- Tour için order summary -->\r\n        <div v-if=\"selectedTourStore.tour\" class=\"order-summary-product\">\r\n          <img class=\"order-summary-img\" :src=\"selectedTourStore.tour.image\" :alt=\"selectedTourStore.tour.title\" />\r\n          <div class=\"order-summary-product-info\">\r\n            <div class=\"product-title\">{{ selectedTourStore.tour.title }}</div>\r\n            <div class=\"product-detail\">{{ selectedTourStore.tour.description }}</div>\r\n            <div class=\"product-detail\" v-if=\"selectedTourStore.tour.bookingDate\">\r\n              <i class=\"fas fa-calendar-alt\"></i> {{ selectedTourStore.tour.bookingDate }}\r\n            </div>\r\n            <div class=\"product-detail\"><i class=\"fas fa-user\"></i> {{ selectedTourStore.tour.participants }}</div>\r\n            <div class=\"product-detail\" v-if=\"selectedTourStore.tour.email\"><i class=\"fas fa-envelope\"></i> {{ selectedTourStore.tour.email }}</div>\r\n            <div class=\"product-detail\" v-if=\"selectedTourStore.tour.userLocation\">\r\n              <i class=\"fas fa-map-marker-alt\"></i>\r\n              <a\r\n                :href=\"getGoogleMapsLink(selectedTourStore.tour.userLocation)\"\r\n                target=\"_blank\"\r\n                rel=\"noopener\"\r\n                style=\"color: #0070eb; text-decoration: underline; cursor: pointer;\"\r\n              >\r\n                {{ selectedTourStore.tour.userLocation }}\r\n              </a>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Pass için order summary -->\r\n        <div v-if=\"selectedTourStore.pass\" class=\"order-summary-product\">\r\n          <div class=\"pass-icon\">\r\n            <i class=\"fas fa-ticket-alt\"></i>\r\n          </div>\r\n          <div class=\"order-summary-product-info\">\r\n            <div class=\"product-title\">{{ selectedTourStore.pass.name }}</div>\r\n            <div class=\"product-detail\">{{ selectedTourStore.pass.days }} Day Istanbul Tourist Pass</div>\r\n            <div class=\"product-detail\" v-if=\"selectedTourStore.pass.startDate\">\r\n              <i class=\"fas fa-calendar-alt\"></i> Start Date: {{ selectedTourStore.pass.startDate }}\r\n            </div>\r\n            <div class=\"product-detail\"><i class=\"fas fa-user\"></i> Quantity: {{ selectedTourStore.pass.quantity }}</div>\r\n            <div class=\"product-detail\" v-if=\"selectedTourStore.pass.email\"><i class=\"fas fa-envelope\"></i> {{ selectedTourStore.pass.email }}</div>\r\n            <div class=\"product-detail\" v-if=\"selectedTourStore.pass.discount\">\r\n              <i class=\"fas fa-tag\"></i> Save {{ selectedTourStore.pass.discount }}€\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"order-summary-total-row\">\r\n          <span>Total</span>\r\n          <span class=\"order-summary-total\">{{ selectedTourStore.tour?.price || selectedTourStore.pass?.totalPrice }}</span>\r\n        </div>\r\n        <div class=\"order-summary-taxes\">All taxes and fees included</div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, onMounted, watch, computed } from 'vue'\r\nimport { useRouter } from 'vue-router'\r\nimport { useSelectedTourStore } from '../stores/selectedTour'\r\nlet stripe, elements, card\r\nimport { loadStripe } from '@stripe/stripe-js';\r\n\r\nconst router = useRouter()\r\nconst selectedTourStore = useSelectedTourStore()\r\n\r\n// Helper function to get language ID from language code\r\nconst getLanguageId = (langCode) => {\r\n  const languageMap = {\r\n    'tr': 2,    // Türkçe\r\n    'de': 6,    // Deutsch\r\n    'en': 1,    // English\r\n    'ar': 3,    // العربية\r\n    'es': 4,    // Español\r\n    'fr': 5,    // Français\r\n    'it': 7,    // Italiano\r\n    'pt': 8,    // Português\r\n    'zh': 10,   // 中文\r\n    'ja': 11,   // 日本語\r\n    'ru': 9     // Русский\r\n  }\r\n  return languageMap[langCode] || 1\r\n}\r\n\r\n// Helper function to get currency ID from currency code\r\nconst getCurrencyId = (currencyCode) => {\r\n  const currencyMap = {\r\n    'EUR': 4,\r\n    'USD': 5,\r\n    'GBP': 6,\r\n    'TRY': 7\r\n  }\r\n  return currencyMap[currencyCode] || 4\r\n}\r\n\r\n// Tüm ülkeler ve kodları\r\nconst countries = [\r\n  { name: 'Turkey', code: '+90', iso: 'TR' },\r\n  { name: 'United States', code: '+1', iso: 'US' },\r\n  { name: 'Germany', code: '+49', iso: 'DE' },\r\n  { name: 'France', code: '+33', iso: 'FR' },\r\n  { name: 'United Kingdom', code: '+44', iso: 'GB' },\r\n  { name: 'Italy', code: '+39', iso: 'IT' },\r\n  { name: 'Spain', code: '+34', iso: 'ES' },\r\n  { name: 'Netherlands', code: '+31', iso: 'NL' },\r\n  { name: 'Russia', code: '+7', iso: 'RU' },\r\n  { name: 'Japan', code: '+81', iso: 'JP' },\r\n  { name: 'China', code: '+86', iso: 'CN' },\r\n  { name: 'India', code: '+91', iso: 'IN' },\r\n  { name: 'Brazil', code: '+55', iso: 'BR' },\r\n  { name: 'Canada', code: '+1', iso: 'CA' },\r\n  { name: 'Australia', code: '+61', iso: 'AU' },\r\n]\r\n\r\nconst country = ref(countries[0].name)\r\nconst phone = ref('')\r\nconst selectedCountry = computed(() => countries.find(c => c.name === country.value) || countries[0])\r\n\r\nconst name = ref('')\r\nconst email = ref(selectedTourStore.tour?.email || selectedTourStore.pass?.email || '')\r\n\r\n// Customer login bilgisini localStorage'dan al\r\nconst customerLogin = ref(null)\r\ntry {\r\n  const customerData = localStorage.getItem('customerLogin')\r\n  if (customerData) {\r\n    customerLogin.value = JSON.parse(customerData)\r\n  }\r\n} catch (error) {\r\n  console.error('Customer login data parse error:', error)\r\n  customerLogin.value = null\r\n}\r\n\r\n// Debug: Tour verilerini kontrol et\r\nconsole.log('Selected Tour Store:', selectedTourStore.tour)\r\nconsole.log('Customer Login:', customerLogin.value)\r\nconst cardName = ref('')\r\nconst loading = ref(false)\r\nconst success = ref(false)\r\nconst errorMsg = ref('')\r\nconst currentStep = ref(1)\r\nconst hotelAddress = ref(\"\");\r\nconst userLocation = ref(\"\");\r\n\r\n// Currency ve language bilgileri\r\nconst currentCurrency = ref(localStorage.getItem('selectedCurrency') || 'EUR')\r\nconst currencyId = computed(() => getCurrencyId(currentCurrency.value))\r\nconst languageId = computed(() => getLanguageId(localStorage.getItem('selectedLanguage') || 'en'))\r\n\r\nonMounted(() => {\r\n  watch(currentStep, (step) => {\r\n    if (step === 2) {\r\n      setTimeout(() => {\r\n        if (!window.Stripe) {\r\n          const script = document.createElement('script')\r\n          script.src = 'https://js.stripe.com/v3/'\r\n          script.onload = setupStripe\r\n          document.head.appendChild(script)\r\n        } else {\r\n          setupStripe()\r\n        }\r\n      }, 0)\r\n    }\r\n  }, { immediate: true })\r\n})\r\n\r\nfunction setupStripe() {\r\n  if (card) return\r\n  // Stripe public key - production'da gerçek key kullanılacak\r\n  stripe = window.Stripe('pk_test_51RmaYhQQzUg4uq68XfoINf2CrffnJsjaJ1OHLwLtNLHHKcJ2uPlQABvQi5gFefQ5CnyJtbBbLOK7yioo2pPhkzfS00bUBXgBV7') // TODO: Replace with your real public key\r\n  elements = stripe.elements()\r\n  card = elements.create('card', {\r\n    style: {\r\n      base: {\r\n        fontSize: '16px',\r\n        color: '#424770',\r\n        '::placeholder': {\r\n          color: '#aab7c4',\r\n        },\r\n      },\r\n      invalid: {\r\n        color: '#9e2146',\r\n      },\r\n    },\r\n  })\r\n  card.mount('#card-element')\r\n}\r\n\r\nfunction getLocation() {\r\n  if (!navigator.geolocation) {\r\n    alert('Geolocation is not supported by your browser');\r\n    return;\r\n  }\r\n  navigator.geolocation.getCurrentPosition(async (position) => {\r\n    const { latitude, longitude } = position.coords;\r\n    try {\r\n      const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);\r\n      const data = await response.json();\r\n      userLocation.value = data.display_name || `${latitude}, ${longitude}`;\r\n    } catch (e) {\r\n      userLocation.value = `${latitude}, ${longitude}`;\r\n    }\r\n  }, (error) => {\r\n    alert('Could not get your location');\r\n  });\r\n}\r\n\r\nfunction getGoogleMapsLink(location) {\r\n  // Eğer koordinat ise (ör: \"41.123, 29.456\")\r\n  if (/^-?\\d+(\\.\\d+)?[, ]+\\s*-?\\d+(\\.\\d+)?$/.test(location)) {\r\n    const coords = location.split(/[ ,]+/).map(Number);\r\n    return `https://www.google.com/maps?q=${coords[0]},${coords[1]}`;\r\n  }\r\n  // Değilse adres olarak arat\r\n  return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;\r\n}\r\n\r\n// Price string'ini kuruş cinsinden integer'a çevir\r\nfunction convertPriceToCents(priceString) {\r\n  if (!priceString) return 0;\r\n  \r\n  // \"€10.00\" formatından sayısal değeri çıkar\r\n  const numericValue = priceString.replace(/[^\\d.,]/g, '').replace(',', '.');\r\n  const amount = parseFloat(numericValue);\r\n  \r\n  // Kuruş cinsinden döndür (1000 = 10.00 TL)\r\n  // Tam hassasiyet için Math.round kullanmıyoruz\r\n  return Math.round(amount * 100);\r\n}\r\n\r\nconst handleStep = async () => {\r\n  if (currentStep.value === 1) {\r\n    if (!name.value || !email.value || !country.value || !phone.value || !hotelAddress.value) {\r\n      errorMsg.value = 'Please fill in all required fields.';\r\n      return;\r\n    }\r\n    currentStep.value = 2;\r\n    return;\r\n  }\r\n\r\n  loading.value = true;\r\n  errorMsg.value = '';\r\n  success.value = false;\r\n\r\n  try {\r\n    // Mevcut Stripe instance'ını kullan, yeni oluşturma\r\n    if (!stripe) {\r\n      throw new Error('Stripe not initialized. Please refresh the page.');\r\n    }\r\n\r\n    // 1. Sadece rezervasyonu ve ödeme bilgilerini backend'e gönder\r\n    const response = await fetch('https://backend.searchyourtour.com/api/submit-booking', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify({\r\n        customer: {\r\n          name: name.value,\r\n          email: email.value,\r\n          phone: selectedCountry.value.code + phone.value,\r\n          country: country.value,\r\n          hotel_address: hotelAddress.value,\r\n          user_location: userLocation.value\r\n        },\r\n        // Tour veya Pass verilerini gönder\r\n        ...(selectedTourStore.tour ? {\r\n          tour: {\r\n            id: selectedTourStore.tour?.id || null,\r\n            title: selectedTourStore.tour?.title || '',\r\n            description: selectedTourStore.tour?.description || '',\r\n            price: selectedTourStore.tour?.price || '',\r\n            booking_date: selectedTourStore.tour?.bookingDate || new Date().toISOString().split('T')[0],\r\n            tenant_id: 'ad5257a5-efdd-4314-9e5e-b56aabe321f1',\r\n            currency_id: currencyId.value,\r\n            language_id: languageId.value,\r\n            buggy: 0,\r\n            adult: selectedTourStore.tour?.adult || 1,\r\n            child: selectedTourStore.tour?.child || 0,\r\n            infant: selectedTourStore.tour?.infant || 0,\r\n            roomNumber: 0,\r\n            randomCode: Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15),\r\n            type: 'tour',\r\n            customer_id: customerLogin.value?.id || 0\r\n          }\r\n        } : {\r\n          pass: {\r\n            id: selectedTourStore.pass?.id || null,\r\n            name: selectedTourStore.pass?.name || '',\r\n            days: selectedTourStore.pass?.days || 1,\r\n            price: selectedTourStore.pass?.price || '',\r\n            total_price: selectedTourStore.pass?.totalPrice || '',\r\n            quantity: selectedTourStore.pass?.quantity || 1,\r\n            start_date: selectedTourStore.pass?.startDate || new Date().toISOString().split('T')[0],\r\n            email: selectedTourStore.pass?.email || '',\r\n            tenant_id: 'ad5257a5-efdd-4314-9e5e-b56aabe321f1',\r\n            currency_id: currencyId.value,\r\n            language_id: languageId.value,\r\n            randomCode: Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15),\r\n            type: 'pass'\r\n          }\r\n        }),\r\n        payment: {\r\n          amount: convertPriceToCents(selectedTourStore.tour?.price || selectedTourStore.pass?.totalPrice || ''),\r\n          currency: currentCurrency.value\r\n        }\r\n      })\r\n    });\r\n\r\n    const data = await response.json();\r\n\r\n    // 2. client_secret geldiyse, Stripe ile ödemeyi başlat\r\n    if (data?.client_secret) {\r\n      const result = await stripe.confirmCardPayment(data.client_secret, {\r\n        payment_method: {\r\n                      card: card, // Stripe Elements component\r\n          billing_details: {\r\n            name: name.value,\r\n            email: email.value,\r\n            phone: selectedCountry.value.code + phone.value,\r\n            address: {\r\n              country: selectedCountry.value.iso,\r\n              line1: hotelAddress.value\r\n            }\r\n          }\r\n        },\r\n        return_url: 'https://yourfrontend.com/payment-status'\r\n      });\r\n\r\n      try {\r\n        const payment_intent_id = data.payment_intent_id;\r\n\r\n        if (result.error) {\r\n          // Hata durumu\r\n          console.error('Ödeme hatası:', result.error.message);\r\n          errorMsg.value = result.error.message || 'Payment failed. Please try again.';\r\n          if (data.reservation_id && payment_intent_id) {\r\n            await fetch('https://backend.searchyourtour.com/api/check_payment_status', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                reservation_id: data.reservation_id,\r\n                randomCode: data.randomCode,\r\n                payment_intent_id: payment_intent_id\r\n              })\r\n            });\r\n          }\r\n        } else if (result.paymentIntent.status === 'succeeded') {\r\n          // Başarılı ödeme\r\n          success.value = true;\r\n          if (data.reservation_id && payment_intent_id) {\r\n            await fetch('https://backend.searchyourtour.com/api/check_payment_status', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                reservation_id: data.reservation_id,\r\n                randomCode: data.randomCode,\r\n                payment_intent_id: payment_intent_id\r\n              })\r\n            });\r\n          }\r\n          // Ödeme başarılıysa yönlendir\r\n          router.push({\r\n            name: 'payment-success',\r\n            query: {\r\n              bookingId: data.reservation_id,\r\n              tourTitle: selectedTourStore.tour?.title || '',\r\n              bookingDate: selectedTourStore.tour?.bookingDate || '',\r\n              amount: selectedTourStore.tour?.price || '',\r\n              customerName: name.value || ''\r\n            }\r\n          });\r\n        } else {\r\n          // Beklemede veya başka bir durum (ör. 3D Secure)\r\n          errorMsg.value = 'Ödeme işlemi tamamlanmadı, ek onay gerekebilir.';\r\n          if (data.reservation_id && payment_intent_id) {\r\n            await fetch('https://backend.searchyourtour.com/api/check_payment_status', {\r\n              method: 'POST',\r\n              headers: { 'Content-Type': 'application/json' },\r\n              body: JSON.stringify({\r\n                reservation_id: data.reservation_id,\r\n                randomCode: data.randomCode,\r\n                payment_intent_id: payment_intent_id\r\n              })\r\n            });\r\n          }\r\n        }\r\n      } catch (err) {\r\n        console.error('Payment error:', err);\r\n        errorMsg.value = err.message || 'Payment failed. Please try again.';\r\n      } finally {\r\n        loading.value = false;\r\n      }\r\n    }\r\n    \r\n  } catch (err) {\r\n    console.error('Payment error:', err);\r\n    errorMsg.value = err.message || 'Payment failed. Please try again.';\r\n  } finally {\r\n    loading.value = false;\r\n  }\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n/* CheckoutForm.vue'dan taşınan stiller */\r\n.checkout-main-layout {\r\n  display: flex;\r\n  gap: 64px;\r\n  align-items: stretch;\r\n  justify-content: center;\r\n  background: #f6f8fa;\r\n  padding: 48px 0;\r\n  min-height: 100vh;\r\n}\r\n.checkout-left, .checkout-right {\r\n  flex: 1 1 0;\r\n  min-width: 340px;\r\n  max-width: 600px;\r\n  background: #fff;\r\n  border-radius: 26px;\r\n  box-shadow: 0 8px 32px rgba(44,62,80,0.10);\r\n  padding: 36px 44px 24px 44px;\r\n  font-family: 'Inter', 'Segoe UI', Arial, sans-serif;\r\n  display: flex;\r\n  flex-direction: column;\r\n  justify-content: flex-start;\r\n  height: 100%;\r\n}\r\n.checkout-left h2 {\r\n  color: #1a2a3a;\r\n  font-size: 2.3rem;\r\n  margin-bottom: 18px;\r\n  font-weight: 900;\r\n  text-align: left;\r\n  letter-spacing: -1px;\r\n}\r\n.secure-checkout {\r\n  color: #0a8a4a;\r\n  font-size: 1.08rem;\r\n  margin-bottom: 18px;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n  font-weight: 600;\r\n}\r\n.checkout-form {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 18px;\r\n}\r\n.form-group {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 4px;\r\n}\r\ninput, select {\r\n  padding: 12px 16px;\r\n  border-radius: 10px;\r\n  border: 2px solid #e0e6ed;\r\n  font-size: 1.08rem;\r\n  background: #f7fafd;\r\n  outline: none;\r\n  transition: border 0.2s;\r\n}\r\ninput:focus, select:focus {\r\n  border-color: #0070eb;\r\n}\r\n.stripe-card-element {\r\n  padding: 12px 16px;\r\n  border-radius: 10px;\r\n  border: 2px solid #e0e6ed;\r\n  background: #f7fafd;\r\n  margin-top: 4px;\r\n}\r\n.form-note {\r\n  font-size: 0.97rem;\r\n  color: #888;\r\n  margin-bottom: 8px;\r\n}\r\n.required { color: #d7263d; }\r\n.pay-btn {\r\n  width: 100%;\r\n  background: linear-gradient(90deg, #FC6421 60%, #ff3401 100%);\r\n  color: #fff;\r\n  font-size: 1.15rem;\r\n  font-weight: 800;\r\n  border: none;\r\n  border-radius: 32px;\r\n  padding: 1.05rem 0;\r\n  margin-top: 8px;\r\n  cursor: pointer;\r\n  transition: background 0.2s, box-shadow 0.2s;\r\n  box-shadow: 0 2px 12px rgba(0,112,235,0.08);\r\n  letter-spacing: 0.5px;\r\n}\r\n.pay-btn:hover {\r\n  background: linear-gradient(90deg, #ff0000 60%, #ff0000 100%);\r\n  box-shadow: 0 4px 24px rgba(0,112,235,0.13);\r\n}\r\n.pay-btn:disabled {\r\n  background: #aaa;\r\n  cursor: not-allowed;\r\n}\r\n.success-message {\r\n  color: #27ae60;\r\n  text-align: center;\r\n  margin-top: 16px;\r\n  font-size: 1.1rem;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  gap: 12px;\r\n  padding: 16px;\r\n  background: #f8fff9;\r\n  border: 1px solid #27ae60;\r\n  border-radius: 8px;\r\n}\r\n\r\n.success-message i {\r\n  font-size: 1.5rem;\r\n  flex-shrink: 0;\r\n}\r\n\r\n.success-message div {\r\n  text-align: left;\r\n}\r\n\r\n.success-message strong {\r\n  display: block;\r\n  margin-bottom: 4px;\r\n}\r\n\r\n.success-message p {\r\n  margin: 0;\r\n  font-size: 0.95rem;\r\n  color: #666;\r\n}\r\n.error-message {\r\n  color: #d7263d;\r\n  text-align: center;\r\n  margin-top: 12px;\r\n  font-size: 1rem;\r\n}\r\n\r\n.order-summary-panel {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 18px;\r\n  height: 100%;\r\n}\r\n.order-summary-product {\r\n  display: flex;\r\n  gap: 22px;\r\n  margin-bottom: 10px;\r\n  align-items: flex-start;\r\n}\r\n.order-summary-img {\r\n  width: 88px;\r\n  height: 88px;\r\n  border-radius: 14px;\r\n  object-fit: cover;\r\n  box-shadow: 0 2px 8px rgba(44,62,80,0.08);\r\n}\r\n.order-summary-product-info {\r\n  flex: 1;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 2px;\r\n}\r\n.product-title {\r\n  font-weight: 900;\r\n  font-size: 1.18rem;\r\n  margin-bottom: 2px;\r\n  color: #1a2a3a;\r\n}\r\n.product-detail {\r\n  font-size: 1.04rem;\r\n  color: #444;\r\n  margin-bottom: 2px;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n}\r\n.order-summary-title {\r\n  font-size: 1.45rem;\r\n  font-weight: 900;\r\n  margin-bottom: 18px;\r\n  color: #1a2a3a;\r\n  letter-spacing: -0.5px;\r\n}\r\n.order-summary-total-row {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  font-size: 1.22rem;\r\n  font-weight: 900;\r\n  margin-top: 10px;\r\n  letter-spacing: 0.2px;\r\n}\r\n.order-summary-total {\r\n  color: #FC6421;\r\n  font-size: 1.32rem;\r\n  font-weight: 900;\r\n}\r\n.order-summary-taxes {\r\n  color: #0a8a4a;\r\n  font-size: 0.97rem;\r\n  margin-top: 2px;\r\n  text-align: right;\r\n}\r\n.phone-row {\r\n  margin-bottom: 0;\r\n}\r\n.phone-input-group {\r\n  display: flex;\r\n  gap: 10px;\r\n  align-items: stretch;\r\n}\r\n.country-code-display {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 6px;\r\n  background: #f7fafd;\r\n  border: 2px solid #e0e6ed;\r\n  border-radius: 10px;\r\n  padding: 12px 16px;\r\n  font-size: 1.08rem;\r\n  min-width: 90px;\r\n  font-weight: 600;\r\n  height: 48px;\r\n  box-sizing: border-box;\r\n}\r\n.flag-option {\r\n  width: 22px;\r\n  height: 16px;\r\n  margin-right: 7px;\r\n  vertical-align: middle;\r\n  border-radius: 3px;\r\n  box-shadow: 0 1px 3px rgba(0,0,0,0.07);\r\n}\r\n.country-select-row {\r\n  margin-bottom: 0;\r\n}\r\n.country-select-flex {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n.country-select-fullwidth {\r\n  width: 100%;\r\n  min-width: 0;\r\n  box-sizing: border-box;\r\n}\r\n.phone-input {\r\n  flex: 1;\r\n  padding: 12px 16px;\r\n  border-radius: 10px;\r\n  border: 2px solid #e0e6ed;\r\n  font-size: 1.08rem;\r\n  background: #f7fafd;\r\n  outline: none;\r\n  transition: border 0.2s;\r\n  height: 48px;\r\n  box-sizing: border-box;\r\n}\r\n.phone-input:focus {\r\n  border-color: #0070eb;\r\n}\r\n.location-btn {\r\n  background: #f7f7f7;\r\n  border: 1px solid #ddd;\r\n  border-radius: 6px;\r\n  font-size: 1.08rem;\r\n  padding: 0 16px;\r\n  height: 48px;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  cursor: pointer;\r\n  transition: background 0.2s;\r\n}\r\n.location-btn:hover {\r\n  background: #eee;\r\n}\r\n.pass-icon {\r\n  width: 88px;\r\n  height: 88px;\r\n  border-radius: 14px;\r\n  background-color: #f7fafd;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  box-shadow: 0 2px 8px rgba(44,62,80,0.08);\r\n  margin-right: 22px;\r\n}\r\n.pass-icon i {\r\n  font-size: 3rem;\r\n  color: #0070eb;\r\n}\r\n@media (max-width: 900px) {\r\n  .checkout-main-layout {\r\n    flex-direction: column;\r\n    gap: 0;\r\n    padding: 0.5rem 0 1rem 0;\r\n    min-height: 100vh;\r\n    width: 100vw;\r\n    background: #fff;\r\n    box-sizing: border-box;\r\n  }\r\n  .checkout-left, .checkout-right, .order-summary-panel {\r\n    width: 100%;\r\n    max-width: 100vw;\r\n    border-radius: 10px;\r\n    box-shadow: 0 2px 8px rgba(44,62,80,0.06);\r\n    padding: 0.7rem 0.5rem;\r\n    margin: 0 0 1rem 0;\r\n    background: #fff;\r\n    box-sizing: border-box;\r\n    min-width: 0;\r\n  }\r\n}\r\n@media (max-width: 600px) {\r\n  body, html {\r\n    background: #fff !important;\r\n    margin: 0 !important;\r\n    padding: 0 !important;\r\n    overflow-x: hidden !important;\r\n  }\r\n  .checkout-main-layout {\r\n    flex-direction: column !important;\r\n    align-items: stretch !important;\r\n    gap: 0 !important;\r\n    padding: 0 12px !important;\r\n    min-height: 100vh !important;\r\n    width: 100vw !important;\r\n    max-width: 100vw !important;\r\n    background: #fff !important;\r\n    box-sizing: border-box !important;\r\n  }\r\n  .checkout-left,\r\n  .checkout-right,\r\n  .order-summary-panel {\r\n    width: 100% !important;\r\n    max-width: 100vw !important;\r\n    min-width: 0 !important;\r\n    border-radius: 10px !important;\r\n    box-shadow: 0 2px 8px rgba(44,62,80,0.06) !important;\r\n    padding: 0.7rem 0.5rem !important;\r\n    margin: 0 auto 1rem auto !important;\r\n    background: #fff !important;\r\n    box-sizing: border-box !important;\r\n  }\r\n  .checkout-left h2 {\r\n    font-size: 1.4rem !important;\r\n    margin-bottom: 14px !important;\r\n  }\r\n  .form-group,\r\n  .country-select-fullwidth,\r\n  .phone-input,\r\n  .country-code-display,\r\n  .pay-btn {\r\n    max-width: 100vw !important;\r\n    min-width: 0 !important;\r\n    box-sizing: border-box !important;\r\n    font-size: 1rem !important;\r\n    padding-left: 0.2rem !important;\r\n    padding-right: 0.2rem !important;\r\n  }\r\n  .order-summary-img {\r\n    width: 44px !important;\r\n    height: 44px !important;\r\n    min-width: 32px !important;\r\n    max-width: 44px !important;\r\n  }\r\n  .product-title,\r\n  .order-summary-title {\r\n    font-size: 1.08rem !important;\r\n    word-break: break-word !important;\r\n  }\r\n  .pay-btn {\r\n    font-size: 1.08rem !important;\r\n    padding: 0.7rem 0 !important;\r\n    margin-top: 0.5rem !important;\r\n    border-radius: 12px !important;\r\n  }\r\n  .form-note {\r\n    font-size: 0.9rem !important;\r\n  }\r\n  /* Scroll edilebilirlik için: */\r\n  .checkout-modal,\r\n  .checkout-content {\r\n    width: 100vw !important;\r\n    max-width: 100vw !important;\r\n    height: 100vh !important;\r\n    max-height: 100vh !important;\r\n    overflow-y: auto !important;\r\n    background: #fff !important;\r\n    border-radius: 0 !important;\r\n    box-shadow: none !important;\r\n    padding: 0 !important;\r\n    margin: 0 !important;\r\n    display: flex !important;\r\n    flex-direction: column !important;\r\n    align-items: stretch !important;\r\n  }\r\n}\r\n</style>\r\n"
        }
    ]
}